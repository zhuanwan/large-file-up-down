<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Document</title>
    <style>
      .p-list {
        list-style: none;
      }
      .p-list li {
        display: flex;
      }
      .p-list li span {
        width: 200px;
      }
    </style>
  </head>
  <body>
    <input type="file" id="uploadBtn" />

    <div id="hashProgress" style="margin: 20px"></div>
    <div id="progress" style="margin: 20px"></div>

    <div style="margin-top: 100px">
      <button id="testGet">测试xhr-get</button>
      <button id="testPost">测试xhr-post</button>
    </div>
  </body>

  <script type="module">
    import request from './request.js'
    const uploadBtn = document.getElementById('uploadBtn')
    const progressBox = document.getElementById('progress')
    const hashProgressBox = document.getElementById('hashProgress')

    const chunkSize = 20 * 1024 * 1024 // 分片1M
    let data = []
    let file = null
    let totalPercentage = 0
    let fileHash

    // 分片
    function sliceFile(file) {
      const chunks = []
      let cur = 0
      while (cur < file.size) {
        chunks.push(file.slice(cur, cur + chunkSize))
        cur += chunkSize
      }
      return chunks
    }

    // 合并文件
    function mergeRequest(filename) {
      request({
        url: '/merge',
        method: 'post',
        data: JSON.stringify({
          filename,
          size: chunkSize,
          length: data.length,
          fileHash: fileHash,
        }),
        headers: {
          'Content-Type': 'application/json;charset=UTF-8',
        },
      }).then((res) => {
        console.log(res)
      })
    }

    // 渲染进度html
    function renderProgress() {
      const str = `
        <div>总进度：${totalPercentage}</div>
        <ul class="p-list">
          <li>
            <span>切片</span>
            <span>大小</span>
            <span>进度</span>
          </li>
          ${(function () {
            return data
              .map(
                (item) => `
            <li>
              <span>${item.filename}-${item.index}</span>
              <span>${item.size}</span>
              <span>${item.percentage}</span>
            </li>
            `
              )
              .join('')
          })()}
        </ul>
      `
      progressBox.innerHTML = str
    }

    // 计算总的进度
    function computedTotalPercent() {
      if (!data.length || !file) {
        return 0
      }
      const loaded = data
        .map((item) => item.curSize || 0)
        .reduce((acc, cur) => acc + cur)

      return (loaded / file.size).toFixed(2)
    }

    // 计算进度
    function createProgressHandler(item) {
      return (e) => {
        item.percentage = e.loaded / e.total
        item.size = e.total
        item.curSize = e.loaded
        totalPercentage = computedTotalPercent()
        renderProgress()
      }
    }
    // 开始上传
    async function uploadChunks() {
      const requestList = data.map(({ chunk, index, fileHash }) => {
        const formData = new FormData()
        formData.append('chunk', chunk)
        formData.append('filename', file.name)
        formData.append('index', index)
        formData.append('fileHash', fileHash)
        return request({
          url: '/upload',
          data: formData,
          onprogress: createProgressHandler(data[index]),
        })
      })

      await Promise.all(requestList)
      await mergeRequest(file.name)
    }

    async function verifyUpload(filename, fileHash) {
      const { data } = await request({
        url: '/verify',
        method: 'get',
        data: {
          filename,
          fileHash,
        },
      })
      return JSON.parse(data)
    }
    // 生成文件hash
    function caculateHash(fileChunkList) {
      return new Promise((resolve) => {
        let worker = new Worker('./hash.js')
        worker.postMessage({ fileChunkList })
        worker.onmessage = (e) => {
          const { percentage, hash } = e.data
          hashProgressBox.innerHTML = `计算hash: ${percentage}`
          if (hash) {
            resolve(hash)
          }
        }
      })
    }
    // 选择文件
    uploadBtn.onchange = async function (e) {
      file = e.target.files[0]
      const filename = file.name
      const fileChunkList = sliceFile(file)
      fileHash = await caculateHash(fileChunkList)
      // 先判断是否需要上传
      const { shouldUpload } = await verifyUpload(filename, fileHash)
      if (!shouldUpload) {
        alert('已经上传成功')
        return
      }

      data = fileChunkList.map((chunk, index) => ({
        filename,
        fileHash,
        chunk,
        index,
        size: 0,
        curSize: 0,
        percentage: 0,
      }))
      uploadChunks()
    }
  </script>

  <script type="module">
    import request from './request.js'
    const testPost = document.getElementById('testPost')
    const testGet = document.getElementById('testGet')
    testPost.onclick = function () {
      request({
        url: '/testPost',
        method: 'post',
        data: JSON.stringify({
          a: 1,
          b: 2,
        }),
        headers: {
          'Content-Type': 'application/json;charset=UTF-8',
        },
      }).then((res) => {
        console.log(res)
      })
    }

    testGet.onclick = function () {
      request({
        url: '/testGet',
        method: 'get',
        data: {
          a: 3,
          b: 4,
        },
      }).then((res) => {
        console.log(res)
      })
    }
  </script>
</html>
